using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Data.SqlClient;
using System.IO;

namespace AppleContactsUI
{
    public partial class Form1 : Form
    {
        private int id;
        public Form1(contact mycontact)
        {
            InitializeComponent();
            fname.Text = mycontact.firstname;
            lname.Text = mycontact.lastname;
            mobile.Text = mycontact.mobile;
            birth.Text = mycontact.birthday;
            home.Text = mycontact.note;
            note.Text = mycontact.note;
            guna2CirclePictureBox1.Image = mycontact.photo;
            id = mycontact.id;
        }
        public Form1()
        {
            InitializeComponent();
        }
        SqlConnection con = new SqlConnection("Data Source=WIN-96AVT5POUC9\\SQLEXPRESS;Initial Catalog=contact;Integrated Security=True");
        private List<contact> Contacts = new List<contact>();
        private void updatelist(string search="")
        {
            con.Open();
            SqlCommand command = con.CreateCommand();
            command.Parameters.AddWithValue("search", search + "%");
            command.CommandText = "SELECT * FROM tblcontact WHERE firstname LIKE @search OR lastname LIKE @search OR CONCAT(firstname,'',lastname) LIKE @search";
            SqlDataReader reader = command.ExecuteReader();
            Contacts.Clear();
            listBox1.Items.Clear();
            while (reader.Read())
            {
                int id = reader.GetInt32(0);
                string firstname = reader.GetString(1);
                string lastname = reader.GetString(2);
                string mobile = reader.GetString(3);
                string birthday = reader.GetString(4);
                string home = reader.GetString(5);
                string note=reader.GetString(6);
                Image photo = Image.FromStream(new MemoryStream(reader.GetSqlBytes(7).Buffer));
                Contacts.Add(new contact(note, firstname, lastname, mobile,birthday,home, id, photo));
                listBox1.Items.Add(firstname+" "+lastname);
            }
            con.Close();
        }

        private void guna2CirclePictureBox1_Click(object sender, EventArgs e)
        {
            OpenFileDialog OD = new OpenFileDialog();
            OD.FileName = "";
            OD.Filter = "Supported Images |*.jpg;*.jpeg;*.png";
            if(OD.ShowDialog() == DialogResult.OK)
            {
                guna2CirclePictureBox1.Load(OD.FileName);
            }
        }

        private void label3_Click(object sender, EventArgs e)
        {

        }
       
        private void guna2Button1_Click(object sender, EventArgs e)
        {
            SqlConnection con = new SqlConnection("Data Source=WIN-96AVT5POUC9\\SQLEXPRESS;Initial Catalog=contact;Integrated Security=True");
            con.Open();
            SqlCommand command = con.CreateCommand();
            command.Parameters.AddWithValue("@photo", new ImageConverter().ConvertTo(guna2CirclePictureBox1.Image, typeof(Byte[])));
            command.Parameters.AddWithValue("@firstname",fname.Text);
            command.Parameters.AddWithValue("@lastname", lname.Text);
            command.Parameters.AddWithValue("@mobile", mobile.Text);
            command.Parameters.AddWithValue("@birthday", birth.Text);
            command.Parameters.AddWithValue("@home", home.Text);
            command.Parameters.AddWithValue("@note", note.Text);
            command.CommandText = "INSERT INTO tblcontact(firstname,lastname,mobile,birthday,home,note,photo) VALUES(@firstname, @lastname, @mobile, @birthday,@home,@note,@photo)";
 
            if (command.ExecuteNonQuery() > 0)
            {
                MessageBox.Show("contact added");
                con.Close();
                updatelist();

            }
            else
            {
                MessageBox.Show("contact didn't added");
                con.Close();
            }

        }

        private void guna2TextBox1_TextChanged(object sender, EventArgs e)
        {
            updatelist(guna2TextBox1.Text);
        }

        private void listBox1_SelectedIndexChanged(object sender, EventArgs e)
        {
            fname.Text = Contacts[listBox1.SelectedIndex].firstname;
            lname.Text = Contacts[listBox1.SelectedIndex].lastname;
            mobile.Text = Contacts[listBox1.SelectedIndex].mobile;
            birth.Text = Contacts[listBox1.SelectedIndex].birthday;
            home.Text = Contacts[listBox1.SelectedIndex].home;
            note.Text = Contacts[listBox1.SelectedIndex].note;
            guna2CirclePictureBox1.Image = Contacts[listBox1.SelectedIndex].photo;
        }
        private void Form1_Load(object sender, EventArgs e)
        {
            updatelist();
        }
        
        //public Form1(contact mycontact)
        //{
        //    InitializeComponent();

        //    fname.Text = mycontact.firstname;
        //    lname.Text = mycontact.lastname;
        //    mobile.Text = mycontact.mobile;
        //    
        //    home.Text = mycontact.home;
        //    id = mycontact.id;
        //    
        //    guna2CirclePictureBox1.Image = mycontact.photo;

        //}


        private void guna2Button3_Click(object sender, EventArgs e)
        {

            SqlConnection con = new SqlConnection("Data Source=WIN-96AVT5POUC9\\SQLEXPRESS;Initial Catalog=contact;Integrated Security=True");
            con.Open();
            SqlCommand command = con.CreateCommand();
            command.Parameters.AddWithValue("@photo", new ImageConverter().ConvertTo(guna2CirclePictureBox1.Image, typeof(Byte[])));
            command.Parameters.AddWithValue("@firstname", fname.Text);
            command.Parameters.AddWithValue("@lastname", lname.Text);
            command.Parameters.AddWithValue("@mobile", mobile.Text);
            command.Parameters.AddWithValue("@birthday", birth.Text);
            command.Parameters.AddWithValue("@home", home.Text);
            command.Parameters.AddWithValue("@note", note.Text);
            command.Parameters.AddWithValue("@id", id);
            command.CommandText = "UPDATE tblcontact SET firstname=@firstname, lastname=@lastname, mobile=@mobile,birthday=@birthday,home=@home ,note=@note, photo=@photo WHERE id=@id";

            if (command.ExecuteNonQuery() > 0)
            {
                MessageBox.Show("contact added");
                updatelist();
                con.Close();
                

            }
            else
            {
                MessageBox.Show("contact didn't added");
                updatelist();
                con.Close();
               
            }

            //SqlConnection con = new SqlConnection("Data Source=WIN-96AVT5POUC9\\SQLEXPRESS;Initial Catalog=contact;Integrated Security=True");
            //con.Open();
            //SqlCommand command = con.CreateCommand();

            //command.Parameters.AddWithValue("@photo", new ImageConverter().ConvertTo(guna2CirclePictureBox1.Image, typeof(Byte[])));
            //command.Parameters.AddWithValue("@firstname", fname.Text);
            //command.Parameters.AddWithValue("@lastname", lname.Text);
            //command.Parameters.AddWithValue("@mobile", mobile.Text);
            //command.Parameters.AddWithValue("@birthday", birth.Text);
            //command.Parameters.AddWithValue("@home", home.Text);
            //command.Parameters.AddWithValue("@note", note.Text);
            //command.Parameters.AddWithValue("@id", id);
            //command.CommandText = "INSERT INTO tblcontact(firstname,lastname,mobile,birthday,home,note,photo) VALUES(@firstname, @lastname, @mobile, @birthday,@home,@note,@photo";
            // string firstname = fname.Text;
            // string lastname = lname.Text;
            // string mobile1 = mobile.Text;
            // string birthday= birth.Text;
            // string home1 = home.Text;
            // string note1 = note.Text;

            // string query = "UPDATE tblcontact set firstname='" + firstname + "',lastname='" + lastname + "',mobile='" + mobile1 + "',birthday='" + birthday + "',home='" + home1 + "',note='" + note1 + "' where mobile=" + mobile1;
            //SqlCommand cmd = new SqlCommand(query,con);
            //if (command.ExecuteNonQuery() > 0)
            //{
            //    MessageBox.Show("contact added");
            //    con.Close();
            //    updatelist();

            //}
            //else
            //{
            //    MessageBox.Show("contact didn't added");
            //    con.Close();
            //}

        }

        private void Form1_Load_1(object sender, EventArgs e)
        {
            // TODO: This line of code loads data into the 'contactDataSet.tblcontact' table. You can move, or remove it, as needed.
            this.tblcontactTableAdapter.Fill(this.contactDataSet.tblcontact);
            updatelist();

        }

        private void delete_Click(object sender, EventArgs e)
        {
            con.Open();
            SqlCommand command = con.CreateCommand();
            command.Parameters.AddWithValue("@id", id);
            command.CommandText = "DELETE FROM tblcontact";
            if(command.ExecuteNonQuery() > 1)
            {
                MessageBox.Show("Contact was deleted!");
                con.Close();
                updatelist();
                Close();
            }
            else
            {
                MessageBox.Show("Unable to delete contact!");
                con.Close();
                updatelist();
            }
        }

        private void guna2Button8_Click(object sender, EventArgs e)
        {
            updatelist();
        }

        private void guna2Button9_Click(object sender, EventArgs e)
        {
            Close();
        }
    }
}
